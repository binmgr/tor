name: Build Tor Static Binaries

on:
  push:
    branches: [main, master]
  schedule:
    - cron: '0 0 1 * *'
  workflow_dispatch:
    inputs:
      tor_version:
        description: 'Tor version (empty for latest)'
        required: false
        default: ''

env:
  OPENSSL_VERSION: "3.2.1"
  LIBEVENT_VERSION: "2.1.12-stable"
  ZLIB_VERSION: "1.3.1"
  ZSTD_VERSION: "1.5.5"
  XZ_VERSION: "5.4.5"

jobs:
  get-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
    steps:
      - name: Get Tor Version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.tor_version }}" ]; then
            VERSION="${{ github.event.inputs.tor_version }}"
          else
            VERSION=$(curl -s https://dist.torproject.org/ | grep -oP 'tor-\K[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+(-[a-z]+)?' | sort -V | tail -1)
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=v${VERSION}" >> $GITHUB_OUTPUT
          echo "Tor version: ${VERSION}"

  build:
    needs: get-version
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/binmgr/toolchain:latest
    # Builds truly static binaries with musl using binmgr/toolchain
    # AMD64: native build, ARM64: cross-compiled from AMD64
    strategy:
      fail-fast: false
      matrix:
        include:
          - { os: linux, arch: amd64, target_os: linux, ext: "" }
          - { os: linux, arch: arm64, target_os: linux, ext: "" }
    steps:
      - name: Setup Build Environment
        run: |
          mkdir -p $HOME/deps
          echo "DEPS_PREFIX=$HOME/deps" >> $GITHUB_ENV
          echo "PKG_CONFIG_PATH=$HOME/deps/lib/pkgconfig" >> $GITHUB_ENV

          if [ "${{ matrix.arch }}" = "amd64" ]; then
            # Native AMD64 build
            echo "CC=gcc" >> $GITHUB_ENV
            echo "CXX=g++" >> $GITHUB_ENV
            echo "AR=ar" >> $GITHUB_ENV
            echo "RANLIB=ranlib" >> $GITHUB_ENV
            echo "STRIP=strip" >> $GITHUB_ENV
            echo "HOST=x86_64-alpine-linux-musl" >> $GITHUB_ENV
          else
            # ARM64 cross-compile (using Bootlin musl toolchain)
            echo "CC=aarch64-linux-gcc" >> $GITHUB_ENV
            echo "CXX=aarch64-linux-g++" >> $GITHUB_ENV
            echo "AR=aarch64-linux-ar" >> $GITHUB_ENV
            echo "RANLIB=aarch64-buildroot-linux-musl-ranlib" >> $GITHUB_ENV
            echo "STRIP=aarch64-linux-strip" >> $GITHUB_ENV
            echo "HOST=aarch64-linux-musl" >> $GITHUB_ENV
          fi

      - name: Build zlib
        run: |
          wget -q https://zlib.net/zlib-${ZLIB_VERSION}.tar.gz
          tar xzf zlib-${ZLIB_VERSION}.tar.gz
          cd zlib-${ZLIB_VERSION}

          # Use CMake for better cross-compilation support
          cmake -DCMAKE_INSTALL_PREFIX=$DEPS_PREFIX \
                -DCMAKE_C_COMPILER=${CC} \
                -DCMAKE_AR=${AR} \
                -DCMAKE_RANLIB=${RANLIB} \
                -DBUILD_SHARED_LIBS=OFF \
                .
          make -j$(nproc)
          make install

      - name: Build OpenSSL
        run: |
          wget -q https://www.openssl.org/source/openssl-${OPENSSL_VERSION}.tar.gz
          tar xzf openssl-${OPENSSL_VERSION}.tar.gz
          cd openssl-${OPENSSL_VERSION}

          # Determine OpenSSL target based on architecture
          case "${{ matrix.arch }}" in
            amd64) TARGET="linux-x86_64" ;;
            arm64) TARGET="linux-aarch64" ;;
          esac

          ./Configure ${TARGET} \
            --prefix=$DEPS_PREFIX \
            --libdir=lib \
            no-shared \
            no-tests \
            no-ui-console

          make -j$(nproc)
          make install_sw

      - name: Build libevent
        run: |
          wget -q https://github.com/libevent/libevent/releases/download/release-${LIBEVENT_VERSION}/libevent-${LIBEVENT_VERSION}.tar.gz
          tar xzf libevent-${LIBEVENT_VERSION}.tar.gz
          cd libevent-${LIBEVENT_VERSION}

          CC=${CC} AR=${AR} RANLIB=${RANLIB} ./configure \
            --prefix=$DEPS_PREFIX \
            --host=${HOST} \
            --enable-static \
            --disable-shared \
            --disable-samples \
            --disable-libevent-regress \
            CFLAGS="-I$DEPS_PREFIX/include $CFLAGS" \
            LDFLAGS="-L$DEPS_PREFIX/lib $LDFLAGS" \
            OPENSSL_CFLAGS="-I$DEPS_PREFIX/include" \
            OPENSSL_LIBS="-L$DEPS_PREFIX/lib -lssl -lcrypto"

          make -j$(nproc)
          make install

      - name: Build zstd
        run: |
          wget -q https://github.com/facebook/zstd/releases/download/v${ZSTD_VERSION}/zstd-${ZSTD_VERSION}.tar.gz
          tar xzf zstd-${ZSTD_VERSION}.tar.gz
          cd zstd-${ZSTD_VERSION}

          make -j$(nproc) lib-release \
            CC=${CC} \
            AR=${AR} \
            RANLIB=${RANLIB} \
            PREFIX=$DEPS_PREFIX

          make install PREFIX=$DEPS_PREFIX
          rm -f $DEPS_PREFIX/lib/libzstd.so* $DEPS_PREFIX/lib/libzstd.dylib* 2>/dev/null || true

      - name: Build xz/liblzma
        run: |
          wget -q https://github.com/tukaani-project/xz/releases/download/v${XZ_VERSION}/xz-${XZ_VERSION}.tar.gz
          tar xzf xz-${XZ_VERSION}.tar.gz
          cd xz-${XZ_VERSION}

          CC=${CC} AR=${AR} RANLIB=${RANLIB} ./configure \
            --prefix=$DEPS_PREFIX \
            --host=${HOST} \
            --enable-static \
            --disable-shared \
            --disable-xz \
            --disable-xzdec \
            --disable-lzmadec \
            --disable-lzmainfo \
            --disable-scripts \
            --disable-doc \
            CFLAGS="$CFLAGS" \
            LDFLAGS="$LDFLAGS"

          make -j$(nproc)
          make install

      - name: Download Tor
        run: |
          TOR_VERSION="${{ needs.get-version.outputs.version }}"
          wget -q "https://dist.torproject.org/tor-${TOR_VERSION}.tar.gz"
          tar xzf tor-${TOR_VERSION}.tar.gz
          mv tor-${TOR_VERSION} tor-src

      - name: Build Tor
        run: |
          cd tor-src

          # Configure flags
          CONFIGURE_FLAGS="
            --prefix=$PWD/../output
            --host=${HOST}
            --enable-static-tor
            --with-libevent-dir=$DEPS_PREFIX
            --with-openssl-dir=$DEPS_PREFIX
            --with-zlib-dir=$DEPS_PREFIX
            --enable-zstd
            --enable-lzma
            --disable-asciidoc
            --disable-manpage
            --disable-html-manual
            --disable-module-relay
            --disable-module-dirauth
            --disable-systemd
            --disable-seccomp
            --disable-libscrypt
            --disable-tool-name-check
          "

          export CFLAGS="-I$DEPS_PREFIX/include -static"
          export LDFLAGS="-L$DEPS_PREFIX/lib -static"
          export LIBS="-lzstd -llzma -lssl -lcrypto -levent -lz"

          ./configure ${CONFIGURE_FLAGS} || { cat config.log; exit 1; }
          make -j$(nproc)
          make install

      - name: Strip Binary
        run: |
          BINARY="output/bin/tor${{ matrix.ext }}"
          ${STRIP} "${BINARY}" 2>/dev/null || strip "${BINARY}" 2>/dev/null || true
          mv "${BINARY}" "tor-${{ matrix.os }}-${{ matrix.arch }}${{ matrix.ext }}"
          ls -la tor-${{ matrix.os }}-${{ matrix.arch }}${{ matrix.ext }}

      - name: Generate Metadata
        run: |
          cat > "tor-${{ matrix.os }}-${{ matrix.arch }}.json" << EOF
          {
            "org.opencontainers.image.title": "Tor Static Build (musl)",
            "org.opencontainers.image.description": "Fully static Tor binary built with musl libc (Alpine Linux)",
            "org.opencontainers.image.version": "${{ needs.get-version.outputs.version }}",
            "org.opencontainers.image.os": "${{ matrix.os }}",
            "org.opencontainers.image.architecture": "${{ matrix.arch }}",
            "org.opencontainers.image.created": "${{ github.event.head_commit.timestamp }}",
            "org.opencontainers.image.source": "${{ github.server_url }}/${{ github.repository }}",
            "org.opencontainers.image.revision": "${{ github.sha }}",
            "org.opencontainers.image.vendor": "${{ github.repository_owner }}",
            "org.opencontainers.image.licenses": "BSD-3-Clause",
            "build.platform": "${{ matrix.os }}-${{ matrix.arch }}",
            "build.libc": "musl",
            "build.static": "true",
            "build.stripped": "true",
            "dependencies.openssl": "${OPENSSL_VERSION}",
            "dependencies.libevent": "${LIBEVENT_VERSION}",
            "dependencies.zlib": "${ZLIB_VERSION}",
            "dependencies.zstd": "${ZSTD_VERSION}",
            "dependencies.xz": "${XZ_VERSION}"
          }
          EOF

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tor-${{ matrix.os }}-${{ matrix.arch }}
          path: |
            tor-${{ matrix.os }}-${{ matrix.arch }}${{ matrix.ext }}
            tor-${{ matrix.os }}-${{ matrix.arch }}.json
          retention-days: 1

  release:
    needs: [get-version, build]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Create Source Archive
        run: |
          # Create source archive without VCS files using git archive
          git archive --format=tar.gz \
              --prefix=tor-builder-${{ needs.get-version.outputs.version }}/ \
              -o tor-builder-source.tar.gz \
              HEAD

          # Verify archive contents
          echo "Source archive contents:"
          tar -tzf tor-builder-source.tar.gz | head -20

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Prepare Release
        run: |
          mkdir -p release
          mv artifacts/* release/ 2>/dev/null || mv artifacts/*/* release/
          mv tor-builder-source.tar.gz release/
          cd release
          chmod +x tor-linux-* 2>/dev/null || true
          # Generate checksums for all release files
          sha256sum tor-* > checksums.txt
          cat checksums.txt

          # Combined metadata
          echo "[" > metadata.json
          first=true
          for f in *.json; do
            [ "$f" = "metadata.json" ] && continue
            [ "$first" = true ] && first=false || echo "," >> metadata.json
            cat "$f" >> metadata.json
          done
          echo "]" >> metadata.json

      - name: Delete Existing Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release delete "${{ needs.get-version.outputs.tag }}" --repo "${{ github.repository }}" --yes --cleanup-tag 2>/dev/null || true

      - name: Create Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ needs.get-version.outputs.tag }}" \
            --repo "${{ github.repository }}" \
            --title "Tor ${{ needs.get-version.outputs.version }}" \
            --notes "## Tor ${{ needs.get-version.outputs.version }} Static Builds

          **Truly static** Linux binaries built with **musl libc** using \`ghcr.io/binmgr/toolchain\`.
          Zero external dependencies - works on any Linux distribution, any version.

          ### Binaries

          | Platform | AMD64 | ARM64 |
          |----------|-------|-------|
          | Linux | \`tor-linux-amd64\` | \`tor-linux-arm64\` |

          ### Source

          - \`tor-builder-source.tar.gz\` - Build scripts and workflow (no VCS files)

          ### Build Info

          **Type**: Fully Static | Stripped | BSD-3-Clause
          **Libc**: musl (Alpine Linux) - universal compatibility
          **Toolchain**: ghcr.io/binmgr/toolchain:latest
          **Dependencies**: OpenSSL ${OPENSSL_VERSION}, libevent ${LIBEVENT_VERSION}, zlib ${ZLIB_VERSION}, zstd ${ZSTD_VERSION}, xz ${XZ_VERSION}

          ### Verification

          \`\`\`bash
          sha256sum -c checksums.txt
          \`\`\`" \
            release/*
